name: Test Images

on:
  push:
    branches:
      - main
    paths:
      - "Dockerfile.*"
      - "dask-worker"
      - "jupyterhub"
      - "jupyterlab"
      - ".github/workflows/build-push-docker.yaml"
    tags:
      - "*"
  pull_request:
    paths:
      - "Dockerfile.*"
      - "dask-worker"
      - "jupyterhub"
      - "jupyterlab"
      - ".github/workflows/build-push-docker.yaml"
env:
  DOCKER_ORG: nebari-dev
  GITHUB_SHA: ${{ github.sha }}

jobs:
  build-test-images:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        dockerfile:
          - jupyterlab
          - jupyterhub
          - dask-worker

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Lint Dockerfiles
        uses: jbergstroem/hadolint-gh-action@v1
        with:
          dockerfile: Dockerfile.${{ matrix.dockerfile }}
          output_format: tty
          error_level: 0

      - name: Build Image
        run: |
          docker build -t ${DOCKER_ORG}/${{ matrix.dockerfile }}:${{ env.GITHUB_SHA }} -f Dockerfile.${{ matrix.dockerfile }} .

      - name: Save Image
        run: |
          docker save ${DOCKER_ORG}/${{ matrix.dockerfile }}:${{ env.GITHUB_SHA }} | gzip > ${{ matrix.dockerfile }}-${{ env.GITHUB_SHA }}.tar.gz

      - name: Upload Image as Artifact
        uses: actions/upload-artifact@v1
        with:
          name: ${{ matrix.dockerfile }}
          path: ${{ matrix.dockerfile }}-${{ env.GITHUB_SHA }}.tar.gz

      - name: Enable caching for Trivy
        uses: actions/cache@v2.1.4
        with:
          path: .trivy
          key: ${{ runner.os }}-trivy-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-trivy-

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          input: /github/workspace/${{ matrix.dockerfile }}-${{ env.GITHUB_SHA }}.tar.gz
          format: "sarif"
          output: "trivy-results.sarif"
          severity: "CRITICAL,HIGH"
          ignore-unfixed: true
          cache-dir: .trivy
          timeout: 30m0s

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: "trivy-results.sarif"

      - name: Correct Trivy cache permissions
        run: sudo chown -R $USER:$GROUP .trivy
